<!DOCTYPE html>
<html>
<head>
    <title>Map Route</title>
    <style>
        #map {
            height: 500px;
            width: 80%;
            margin: auto;
            margin-top: 20px;
        }
        form {
            text-align: center;
            margin-top: 20px;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBEZA6PUdw8jk8-u0kVyhGIsh1F3LSSkT4"></script>
    <link rel="stylesheet" href="/style/styles.css">
</head>
<body>
    <form id="routeForm">
        <label for="start">Start Location:</label>
        <select name="start" id="start">
            <option>Clock Tower, Dehradun, Uttarakhand</option>
            <option>ISBT (Inter-State Bus Terminal) Dehradun, Dehradun, Uttarakhand</option>
            <option>Rajpur Road, Dehradun, Uttarakhand</option>
            <option>Pacific Mall, Dehradun, Uttarakhand</option>
            <option>Clement Town, Dehradun, Uttarakhand</option>
        </select>
        <label for="end">End Location:</label>
        <select name="end" id="end">
            <option>Clock Tower, Dehradun, Uttarakhand</option>
            <option>ISBT (Inter-State Bus Terminal) Dehradun, Dehradun, Uttarakhand</option>
            <option>Rajpur Road, Dehradun, Uttarakhand</option>
            <option>Pacific Mall, Dehradun, Uttarakhand</option>
            <option>Clement Town, Dehradun, Uttarakhand</option>
        </select>
        <button type="button" onclick="fetchShortestPath()">Get Shortest Path</button>
    </form>

    <div id="map"></div>

    <script>
        let map, directionsService, directionsRenderer;

        function initMap() {
            const center = { lat: 30.3165, lng: 78.0322 }; // Dehradun coordinates
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: center
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            // Draw all graph edges in blue
            const coordinates = {
                "Clock Tower, Dehradun, Uttarakhand": { lat: 30.3165, lng: 78.0322 },
                "ISBT (Inter-State Bus Terminal) Dehradun, Dehradun, Uttarakhand": { lat: 30.2849, lng: 78.0744 },
                "Rajpur Road, Dehradun, Uttarakhand": { lat: 30.3450, lng: 78.0488 },
                "Pacific Mall, Dehradun, Uttarakhand": { lat: 30.3255, lng: 78.0412 },
                "Clement Town, Dehradun, Uttarakhand": { lat: 30.2600, lng: 78.0890 }
            };

            Object.keys(coordinates).forEach(location => {
                new google.maps.Marker({
                    position: coordinates[location],
                    map: map,
                    title: location
                });
            });


            const graphEdges = [
                ["Clock Tower, Dehradun, Uttarakhand", "ISBT (Inter-State Bus Terminal) Dehradun, Dehradun, Uttarakhand"],
                ["Clock Tower, Dehradun, Uttarakhand", "Rajpur Road, Dehradun, Uttarakhand"],
                ["Clock Tower, Dehradun, Uttarakhand", "Pacific Mall, Dehradun, Uttarakhand"],
                ["Clock Tower, Dehradun, Uttarakhand", "Clement Town, Dehradun, Uttarakhand"],
                ["ISBT (Inter-State Bus Terminal) Dehradun, Dehradun, Uttarakhand", "Rajpur Road, Dehradun, Uttarakhand"],
                ["ISBT (Inter-State Bus Terminal) Dehradun, Dehradun, Uttarakhand", "Pacific Mall, Dehradun, Uttarakhand"],
                ["ISBT (Inter-State Bus Terminal) Dehradun, Dehradun, Uttarakhand", "Clement Town, Dehradun, Uttarakhand"],
                ["Rajpur Road, Dehradun, Uttarakhand", "Pacific Mall, Dehradun, Uttarakhand"],
                ["Rajpur Road, Dehradun, Uttarakhand", "Clement Town, Dehradun, Uttarakhand"],
                ["Pacific Mall, Dehradun, Uttarakhand", "Clement Town, Dehradun, Uttarakhand"]
            ];

            graphEdges.forEach(([from, to]) => {
                const edgePath = new google.maps.Polyline({
                    path: [coordinates[from], coordinates[to]],
                    geodesic: true,
                    strokeColor: "#0000AA",
                    strokeOpacity: 0.5,
                    strokeWeight: 1,
                });
                edgePath.setMap(map);
            });
        }

        async function fetchShortestPath() {
            const start = document.getElementById("start").value;
            const end = document.getElementById("end").value;

            try {
                const response = await fetch(`/calculate-distances?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
                if (!response.ok) {
                    throw new Error("Failed to fetch shortest path");
                }
                const data = await response.json();
                console.log("Shortest path data received from server:", data);

                // Render the shortest path on the map
                const coordinates = {
                    "Clock Tower, Dehradun, Uttarakhand": { lat: 30.3165, lng: 78.0322 },
                    "ISBT (Inter-State Bus Terminal) Dehradun, Dehradun, Uttarakhand": { lat: 30.2849, lng: 78.0744 },
                    "Rajpur Road, Dehradun, Uttarakhand": { lat: 30.3450, lng: 78.0488 },
                    "Pacific Mall, Dehradun, Uttarakhand": { lat: 30.3255, lng: 78.0412 },
                    "Clement Town, Dehradun, Uttarakhand": { lat: 30.2600, lng: 78.0890 }
                };
                const pathCoordinates = data.pathToEnd.map(location => coordinates[location]);

                const path = new google.maps.Polyline({
                    path: pathCoordinates,
                    geodesic: true,
                    strokeColor: "#0000AA", // Darker blue
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                });

                path.setMap(map);

                // Add markers for the start and end locations
                const startMarker = new google.maps.Marker({
                    position: pathCoordinates[0], // Start location
                    map: map,
                    title: "Start: " + start
                });

                const endMarker = new google.maps.Marker({
                    position: pathCoordinates[pathCoordinates.length - 1], // End location
                    map: map,
                    title: "End: " + end
                });
            } catch (error) {
                console.error(error);
                alert("Could not fetch the shortest path. Please try again.");
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>